<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>é‹å‹•è¨˜éŒ„</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      margin: 20px;
      background-color: #fafafa;
      color: #333;
    }
    h1 { text-align: center; margin-bottom: 5px; }
    #todayDate { text-align: center; font-size: 14px; color: #666; margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 25px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; font-size: 13px; }
    th { background-color: #f3f3f3; }
    .chart-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; align-items: start; }
    .chart-box { background: #fff; border-radius: 12px; padding: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; }
    .chart-box h3 { font-size: 15px; margin-bottom: 6px; }
    .avg-box { font-size: 13px; margin-top: 4px; color: #555; }
    canvas { width: 100% !important; height: 220px !important; }
    @media (max-width: 600px) { body { margin: 10px; } h1 { font-size: 18px; } th, td { font-size: 11px; } canvas { height: 160px !important; } }
  </style>
</head>
<body>
  <h1>ğŸ‹ï¸â€â™€ï¸ Workout é‹å‹•è¨˜éŒ„</h1>
  <div id="todayDate"></div>

  <h2>ğŸ—“ï¸ æœ€è¿‘ 10 ç­†é‹å‹•ç´€éŒ„</h2>
  <div id="recentTable"></div>

  <div class="chart-container">
    <div class="chart-box">
      <h3>ğŸƒâ€â™‚ï¸ æœ‰æ°§æ´»å‹•æ™‚é–“ (min)</h3>
      <canvas id="aerobicChart"></canvas>
      <div class="avg-box" id="avgAerobic"></div>
    </div>
    <div class="chart-box">
      <h3>ğŸ“‹ æ•™ç·´æŒ‡å®šä½œæ¥­å®Œæˆæ¬¡æ•¸</h3>
      <canvas id="assignedChart"></canvas>
      <div class="avg-box" id="avgAssigned"></div>
    </div>
    <div class="chart-box">
      <h3>ğŸ’ª è‚ŒåŠ›è¨“ç·´æ¬¡æ•¸</h3>
      <canvas id="strengthChart"></canvas>
      <div class="avg-box" id="avgStrength"></div>
    </div>
  </div>

  <script>
    // é¡¯ç¤ºä»Šå¤©æ—¥æœŸ
    const todayElement = document.getElementById("todayDate");
    const today = new Date();
    const options = { year: "numeric", month: "long", day: "numeric", weekday: "long" };
    todayElement.textContent = `ğŸ“… ä»Šå¤©æ—¥æœŸï¼š${today.toLocaleDateString("zh-TW", options)}`;

    let allData = [];
    let chartInstances = {};

    // è®€å– sport.csv
    Papa.parse("sport.csv", {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: function(results) {
        allData = results.data.map(r => ({
          date: r["æ—¥æœŸ"],
          running: +r["è·‘æ­¥(min)"] || 0,
          weight: +r["è‚ŒåŠ›è¨“ç·´"] || 0,
          ball: +r["çƒé¡(min)"] || 0,
          assigned: +r["æ•™ç·´æŒ‡å®š"] || 0,
          trail: +r["å¥è¡Œ(min)"] || 0,
          yoga: +r["ç‘œä¼½"] || 0,
          other: +r["å…¶ä»–"] || 0,
          speed: r["è·‘é€Ÿ"] || "",
          heart_rate: r["å¿ƒç‡"] || "",
          remark: r["å‚™è¨»"] || ""
        })).filter(d => d.date);

        allData.sort((a,b)=>new Date(a.date)-new Date(b.date));
        renderAll();
      },
      error: function(err) { console.error("è®€å– CSV éŒ¯èª¤ï¼š", err); alert("ç„¡æ³•è®€å– sport.csv"); }
    });

    function renderAll() {
      const sorted = [...allData].sort((a,b)=>new Date(b.date)-new Date(a.date));
      renderRecentTable(sorted.slice(0,10));

      const monthly = {};
      allData.forEach(item => {
        const ym = item.date.slice(0,7);
        if (!monthly[ym]) monthly[ym]={ running:0, weight:0, ball:0, assigned:0, trail:0, yoga:0, other:0 };
        monthly[ym].running += item.running;
        monthly[ym].weight += item.weight;
        monthly[ym].ball += item.ball;
        monthly[ym].assigned += item.assigned;
        monthly[ym].trail += item.trail;
        monthly[ym].yoga += item.yoga;
        monthly[ym].other += item.other;
      });

      let labels = Object.keys(monthly).sort();
      let sums = Object.values(monthly).map(d=>({
        aerobic: d.running + d.ball + d.trail,
        assigned: d.assigned,
        strength: d.weight + d.yoga
      }));

      if(labels.length>12) { labels=labels.slice(-12); sums=sums.slice(-12); }

      renderCharts(labels,sums);
      renderAverages(sums);
    }

    function renderRecentTable(data){
      const container = document.getElementById("recentTable");
      container.innerHTML="";
      const table=document.createElement("table");
      const thead=`<thead><tr>
        <th>æ—¥æœŸ</th><th>è·‘æ­¥(min)</th><th>è‚ŒåŠ›è¨“ç·´</th>
        <th>çƒé¡(min)</th><th>æ•™ç·´æŒ‡å®š</th>
        <th>å¥è¡Œ(min)</th><th>ç‘œä¼½</th><th>å…¶ä»–</th><th>è·‘é€Ÿ</th><th>å¿ƒç‡</th><th>å‚™è¨»</th>
      </tr></thead>`;
      const tbody=data.map(r=>`<tr>
        <td>${r.date}</td><td>${r.running}</td><td>${r.weight}</td>
        <td>${r.ball}</td><td>${r.assigned}</td><td>${r.trail}</td>
        <td>${r.yoga}</td><td>${r.other}</td><td>${r.speed}</td>
        <td>${r.heart_rate}</td><td>${r.remark}</td>
      </tr>`).join("");
      table.innerHTML = thead+"<tbody>"+tbody+"</tbody>";
      container.appendChild(table);
    }

    function renderCharts(labels,sums){
      const datasets = [
        { id: "aerobicChart", label: "æœ‰æ°§æ´»å‹•æ™‚é–“", key: "aerobic", color: "#36b9cc" },
        { id: "assignedChart", label: "æ•™ç·´æŒ‡å®šä½œæ¥­", key: "assigned", color: "#f6c23e" },
        { id: "strengthChart", label: "è‚ŒåŠ›è¨“ç·´", key: "strength", color: "#4e73df" }
      ];
      datasets.forEach(({id,label,key,color})=>{
        if(chartInstances[id]) chartInstances[id].destroy();
        const ctx=document.getElementById(id);
        chartInstances[id]=new Chart(ctx,{
          type:"bar",
          data:{ labels, datasets:[{ label, data:sums.map(x=>x[key]), backgroundColor:color+"99", borderColor:color, borderWidth:1 }] },
          plugins:[ChartDataLabels],
          options:{ responsive:true, scales:{y:{beginAtZero:true}}, plugins:{legend:{display:false}, datalabels:{color:'#111', anchor:'end', align:'bottom', font:{weight:'bold',size:12}}} }
        });
      });
    }

    function renderAverages(sums){
      const avg = arr => arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(1
