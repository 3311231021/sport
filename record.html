<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>ğŸ‹ï¸â€â™€ï¸ é‹å‹•è¨˜éŒ„ Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <style>
    body { font-family:"Segoe UI",Arial,sans-serif; margin:20px; background:#fafafa; color:#333; }
    h1,h2{text-align:center;}
    table{width:100%;border-collapse:collapse;margin-bottom:25px;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.1);border-radius:10px;overflow:hidden;}
    th,td{border:1px solid #ddd;padding:8px;text-align:center;font-size:13px;}
    th{background:#f3f3f3;}
    .chart-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;}
    .chart-box{background:#fff;border-radius:12px;padding:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1);text-align:center;}
    .chart-box h3{font-size:15px;margin-bottom:6px;}
    .avg-box{font-size:13px;margin-top:4px;color:#555;}
    canvas{width:100% !important;height:220px !important;}
    @media (max-width:600px){canvas{height:160px !important;}}
  </style>
</head>
<body>
  <h1>ğŸ‹ï¸â€â™€ï¸ Workout é‹å‹•è¨˜éŒ„</h1>

  <h2>ğŸ—“ï¸ æœ€è¿‘é‹å‹•ç´€éŒ„</h2>
  <div id="recentTable"></div>

  <div class="chart-container">
    <div class="chart-box">
      <h3>ğŸƒâ€â™‚ï¸ æœ‰æ°§æ´»å‹•æ™‚é–“ (min)</h3>
      <canvas id="aerobicChart"></canvas>
      <div class="avg-box" id="avgAerobic"></div>
    </div>
    <div class="chart-box">
      <h3>ğŸ“‹ æ•™ç·´æŒ‡å®šä½œæ¥­å®Œæˆæ¬¡æ•¸</h3>
      <canvas id="assignedChart"></canvas>
      <div class="avg-box" id="avgAssigned"></div>
    </div>
    <div class="chart-box">
      <h3>ğŸ’ª è‚ŒåŠ›è¨“ç·´æ¬¡æ•¸</h3>
      <canvas id="strengthChart"></canvas>
      <div class="avg-box" id="avgStrength"></div>
    </div>
  </div>

  <script>
    let allData = [];

    // ======= è®€å– sport.csv =======
    fetch("sport.csv")
      .then(res => res.text())
      .then(text => {
        // è§£æ CSVï¼Œå‡è¨­ç¬¬ä¸€åˆ—æ˜¯æ¬„ä½åç¨±ï¼Œé€—è™Ÿåˆ†éš”
        const lines = text.trim().split("\n");
        const headers = lines[0].split(",");
        allData = lines.slice(1).map(line=>{
          const cols = line.split(",");
          return {
            date: cols[0],
            running: +cols[1] || 0,
            weight: +cols[2] || 0,
            ball: +cols[3] || 0,
            assigned: +cols[4] || 0,
            trail: +cols[5] || 0,
            yoga: +cols[6] || 0,
            other: +cols[7] || 0
          };
        });

        renderAll();
      })
      .catch(err=>{
        console.error("è®€å– CSV éŒ¯èª¤:", err);
        alert("ç„¡æ³•è®€å– sport.csvï¼Œè«‹ç¢ºèªæª”æ¡ˆå­˜åœ¨åŒä¸€è³‡æ–™å¤¾ä¸¦å‘½åæ­£ç¢ºã€‚");
      });

    function renderRecentTable(data){
      const container=document.getElementById("recentTable");
      container.innerHTML="";
      const table=document.createElement("table");
      const thead=`
        <thead><tr>
          <th>æ—¥æœŸ</th><th>è·‘æ­¥(min)</th><th>è‚ŒåŠ›è¨“ç·´</th><th>çƒé¡(min)</th>
          <th>æ•™ç·´æŒ‡å®š</th><th>å¥è¡Œ(min)</th><th>ç‘œä¼½</th><th>å…¶ä»–</th>
        </tr></thead>`;
      const tbody=data.map(r=>`
        <tr>
          <td>${r.date}</td>
          <td>${r.running}</td>
          <td>${r.weight}</td>
          <td>${r.ball}</td>
          <td>${r.assigned}</td>
          <td>${r.trail}</td>
          <td>${r.yoga}</td>
          <td>${r.other}</td>
        </tr>`).join("");
      table.innerHTML=thead+"<tbody>"+tbody+"</tbody>";
      container.appendChild(table);
    }

    function renderCharts(labels,sums){
      const chartDefs=[
        {id:"aerobicChart",key:"aerobic",label:"æœ‰æ°§æ´»å‹•",color:"#36b9cc"},
        {id:"assignedChart",key:"assigned",label:"æ•™ç·´æŒ‡å®š",color:"#f6c23e"},
        {id:"strengthChart",key:"strength",label:"è‚ŒåŠ›è¨“ç·´",color:"#4e73df"}
      ];

      chartDefs.forEach(({id,key,label,color})=>{
        const ctx=document.getElementById(id);
        new Chart(ctx,{
          type:"bar",
          data:{labels,datasets:[{label,data:sums.map(x=>x[key]),backgroundColor:color+"99",borderColor:color,borderWidth:1}]},
          plugins:[ChartDataLabels],
          options:{
            responsive:true,
            scales:{y:{beginAtZero:true}},
            plugins:{
              legend:{display:false},
              datalabels:{
                color:'#111',
                anchor:'center',
                align:'center',
                font:{weight:'bold',size:12},
                formatter:value=>value>0?value:''
              }
            }
          }
        });
      });
    }

    function renderAverages(sums){
      const avg=arr=>arr.length?(arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(1):0;
      document.getElementById("avgAerobic").innerText=`ğŸ“Š å¹³å‡ï¼š${avg(sums.map(x=>x.aerobic))} åˆ†é˜/æœˆ`;
      document.getElementById("avgAssigned").innerText=`ğŸ“Š å¹³å‡ï¼š${avg(sums.map(x=>x.assigned))} æ¬¡/æœˆ`;
      document.getElementById("avgStrength").innerText=`ğŸ“Š å¹³å‡ï¼š${avg(sums.map(x=>x.strength))} æ¬¡/æœˆ`;
    }

    function renderAll(){
      const sorted=[...allData].sort((a,b)=>new Date(b.date)-new Date(a.date));
      renderRecentTable(sorted.slice(0,10));

      const monthly={};
      allData.forEach(item=>{
        const ym=item.date.slice(0,7);
        if(!monthly[ym]) monthly[ym]={running:0,weight:0,ball:0,assigned:0,trail:0,yoga:0,other:0};
        monthly[ym].running+=item.running;
        monthly[ym].weight+=item.weight;
        monthly[ym].ball+=item.ball;
        monthly[ym].assigned+=item.assigned;
        monthly[ym].trail+=item.trail;
        monthly[ym].yoga+=item.yoga;
        monthly[ym].other+=item.other;
      });

      const labels=Object.keys(monthly).sort();
      const sums=Object.values(monthly).map(d=>({
        aerobic:d.running+d.ball+d.trail,
        assigned:d.assigned,
        strength:d.weight+d.yoga
      }));

      renderCharts(labels,sums);
      renderAverages(sums);
    }
  </script>
</body>
</html>
